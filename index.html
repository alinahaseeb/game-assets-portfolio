<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alina Haseeb — Game Assets</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300..900&display=swap" rel="stylesheet">
  <!-- cache-bust the stylesheet -->
  <link rel="stylesheet" href="/style.css?v=2" />
</head>

<body class="layout">
  <!-- Fixed left: 25% width -->
  <aside class="sidebar">
    <h1 class="brand"><a href="https://alinahaseeb.com/">Alina Haseeb</a></h1>
    <nav id="asset-list" class="asset-list"></nav>
    <div class="sidebar-footer">© <span id="year"></span></div>
  </aside>

  <!-- Right: scrollable masonry grid -->
  <main class="gallery">
    <div id="grid" class="masonry"></div>
  </main>

  <script>
    (async () => {
      const res = await fetch('/manifest.json', { cache: 'no-store' });
      const items = await res.json();
      const bySlug = Object.fromEntries(items.map(i => [i.slug, i]));

      const list = document.getElementById('asset-list');
      const gallery = document.querySelector('.gallery');
      const isVideo = url => /\.mp4(\?|$)/i.test(url || '');

      // --- Platform detection
      const ua = navigator.userAgent || '';
      const isIOS = /\b(iPad|iPhone|iPod)\b/i.test(ua) ||
        (/\bMacintosh\b/.test(ua) && 'ontouchend' in document);
      const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      const isAndroidLike = isTouch && !isIOS; // covers Android/mobile Chromium

      // --- Helper: extract numeric prefix from a file/url like "10_foo.mp4"
      const num = (s) => (s?.match(/(?:^|\/)(\d+)_/) || [, ''])[1] || '';

      // --- Thumbnails (static PNGs you uploaded)
      const THUMB_BASE = (items[0]?.posterSrc || '').replace(/\/[^\/]+$/, '');
      const THUMB_FILES = [
        "10_dragonfountain_thumbnail.png", "11_tundratrees_thumbnail.png", "12_goblinhouse_thumbnail.png",
        "13_dock_thumbnail.png", "14_room_thumbnail.png", "15_volcano_thumbnail.png", "1_potion_thumbnail.png",
        "2_potion_thumbnail.png", "3_furnitureassets_thumbnail.png", "4_oceancutout_thumbnail.png",
        "5_jungletrees_thumbnail.png", "6_orc_thumbnail.png", "7_gardenassets_thumbnail.png",
        "8_waterfall_thumbnail.png", "9_bed_thumbnail.png"
      ];
      const THUMBS = THUMB_FILES.reduce((m, f) => { m[f.split('_')[0]] = `${THUMB_BASE}/${f}`; return m; }, {});

      // ----- Sidebar list (sorted by numeric prefix if present)
      const withIndex = items.map(i => {
        const src = i.posterSrc || i.images?.[0] || '';
        const m = src.match(/(?:^|\/)(\d+)_/);
        return { i, n: m ? parseInt(m[1], 10) : Number.MAX_SAFE_INTEGER };
      }).sort((a, b) => a.n - b.n);

      list.innerHTML = withIndex.map(({ i }) =>
        `<a class="asset-link" data-slug="${i.slug}" href="/project.html?slug=${encodeURIComponent(i.slug)}">${i.title || i.slug}</a>`
      ).join('');

      // ------- Grid -------
      function renderGrid() {
        gallery.innerHTML = `<div id="grid" class="masonry"></div>`;
        const g = document.getElementById('grid');

        g.innerHTML = items
          .filter(i => i.section === 'production')
          .map(i => {
            const poster = i.posterSrc || (i.images?.[0] || '');
            const n = num(poster) || num(i.images?.[0] || '') || num(i.slug);
            const thumb = THUMBS[n] || poster;

            // iOS: static image + Preview button; Desktop/Android: video element (paused)
            const media = isIOS
              ? `<div class="card-media-wrap">
                 <img class="card-media" loading="lazy" alt="${i.title}" src="${thumb}">
                 <button class="preview-btn" type="button">Preview</button>
               </div>`
              : `<div class="card-media-wrap">
                 <video class="card-media" muted preload="metadata" playsinline
                        onmouseenter="this.currentTime=0; this.play()"
                        onmouseleave="this.pause(); this.currentTime=0;">
                   <source src="${poster}" type="video/mp4">
                 </video>
               </div>`;

            // store video src for iOS preview button
            return `
            <a class="card" data-slug="${i.slug}" data-video="${poster}"
               href="/project.html?slug=${encodeURIComponent(i.slug)}" title="${i.title || i.slug}">
              ${media}
            </a>`;
          }).join('');

        // Desktop hover (unchanged) + cap at 5s
        if (!isTouch) {
          g.querySelectorAll('video.card-media').forEach(v => {
            v.addEventListener('timeupdate', () => { if (v.currentTime >= 5) v.pause(); }, { passive: true });
          });
        }

        // Android-like touch: press & hold & you can scroll — start on touchstart, stop on end/cancel, cap 5s
        if (isAndroidLike) {
          g.querySelectorAll('video.card-media').forEach(v => {
            let started = false;
            let startX = 0, startY = 0, startT = 0;

            const stop = () => { v.pause(); try { v.currentTime = 0; } catch { } started = false; };

            v.addEventListener('touchstart', (e) => {
              // record gesture
              const t = e.touches[0];
              startX = t.clientX; startY = t.clientY; startT = Date.now();
              // start immediately so no long-press delay
              try { v.currentTime = 0; } catch { }
              v.play().catch(() => { });
              started = true;
            }, { passive: true });

            v.addEventListener('touchmove', (e) => {
              // keep playing while scrolling; if they fling far, still okay
              // optional: if you want to cancel after huge movement, uncomment:
              // const t = e.touches[0]; if (Math.hypot(t.clientX-startX, t.clientY-startY) > 250) stop();
            }, { passive: true });

            v.addEventListener('touchend', (e) => {
              // If it was a real press (held >120ms or moved >8px), cancel the upcoming click to avoid navigation
              const dt = Date.now() - startT;
              const t0 = (e.changedTouches && e.changedTouches[0]) || { clientX: startX, clientY: startY };
              const moved = Math.hypot((t0.clientX - startX), (t0.clientY - startY));
              if (started && (dt > 120 || moved > 8)) {
                const card = v.closest('a.card');
                if (card) {
                  const cancelClick = (ev) => { ev.preventDefault(); ev.stopPropagation(); };
                  card.addEventListener('click', cancelClick, { capture: true, once: true });
                }
              }
              stop();
            }, { passive: true });

            v.addEventListener('touchcancel', () => stop(), { passive: true });

            // cap preview to 5s
            v.addEventListener('timeupdate', () => { if (v.currentTime >= 5) v.pause(); }, { passive: true });

            // suppress long-press context menu
            v.addEventListener('contextmenu', (e) => e.preventDefault());
          });
        }

        // iOS: Preview button overlays a 5s video (unchanged from your last working version)
        if (isIOS) {
          g.addEventListener('click', (e) => {
            const btn = e.target.closest('.preview-btn');
            if (!btn) return;
            e.preventDefault(); e.stopPropagation();

            const card = btn.closest('a.card');
            const wrap = card.querySelector('.card-media-wrap');
            const img = wrap.querySelector('img.card-media');
            const src = card.getAttribute('data-video');
            if (!src) return;

            // remove any existing overlay on this card
            const existing = wrap.querySelector('video.ios-preview');
            if (existing) existing.remove();

            // build overlay video
            const v = document.createElement('video');
            v.className = 'card-media ios-preview';
            v.muted = true;
            v.playsInline = true;
            v.preload = 'metadata';
            v.src = src;
            if (img) v.setAttribute('poster', img.currentSrc || img.src);

            wrap.appendChild(v);
            try { v.currentTime = 0; } catch { }
            v.play().catch(() => { });
            const stop = () => { try { v.pause(); } catch { }; v.remove(); };
            const tm = setTimeout(stop, 5000);
            v.addEventListener('ended', stop, { once: true });
            v.addEventListener('timeupdate', () => { if (v.currentTime >= 5) { clearTimeout(tm); stop(); } }, { passive: true });
          });
        }
      }

      // ------- Detail view (unchanged) -------
      function renderDetail(slug, push = true) {
        const item = bySlug[slug];
        if (!item) { renderGrid(); return; }

        const poster = item.posterSrc ? [item.posterSrc] : [];
        const imgs = item.images || [];
        const vids = (item.videos || []).filter(v => v !== item.posterSrc);
        const mediaOrder = [...poster, ...imgs, ...vids];

        gallery.innerHTML = `
        <section class="detail" data-slug="${slug}">
          <div class="detail-header">
            <button class="detail-back" type="button" aria-label="Back to gallery">← Back</button>
            <div>
              <h1 class="detail-title">${item.title || item.slug}</h1>
              <p class="detail-meta">${[item.client, item.year].filter(Boolean).join(' · ')}</p>
            </div>
          </div>
          <div class="detail-media">
            ${mediaOrder.map(src => `
              <div class="frame">
                ${isVideo(src)
            ? `<video controls preload="metadata" playsinline>
                       <source src="${src}" type="video/mp4">
                     </video>`
            : `<img loading="lazy" src="${src}" alt="${item.title || item.slug}">`
          }
              </div>
            `).join('')}
          </div>
        </section>
      `;

        gallery.querySelector('.detail-back').addEventListener('click', () => {
          if (history.state && history.state.slug) history.back();
          else renderGrid(), history.replaceState(null, '', '/');
        });

        if (push) {
          const url = `/?slug=${encodeURIComponent(slug)}`;
          history.pushState({ slug }, '', url);
          document.title = `${item.title || item.slug} — Game Assets`;
        }
      }

      // ------- Routing -------
      function openFromEvent(e) {
        const a = e.target.closest('a[data-slug]');
        if (!a) return;
        // If iOS preview button is clicked, it's handled above
        if (e.target.closest('.preview-btn')) return;
        e.preventDefault();
        renderDetail(a.getAttribute('data-slug'), true);
      }
      document.body.addEventListener('click', openFromEvent);

      window.addEventListener('popstate', (ev) => {
        const slug = ev.state?.slug || new URLSearchParams(location.search).get('slug');
        if (slug && bySlug[slug]) renderDetail(slug, false);
        else { renderGrid(); document.title = 'Game Assets'; }
      });

      // Initial route
      const initialSlug = new URLSearchParams(location.search).get('slug');
      if (initialSlug && bySlug[initialSlug]) renderDetail(initialSlug, false);
      else renderGrid();

      document.getElementById('year').textContent = new Date().getFullYear();
    })();
  </script>
</body>

</html>