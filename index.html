<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alina Haseeb — Game Assets</title>
  <!-- cache-bust the stylesheet -->
  <link rel="stylesheet" href="/style.css?v=2" />
</head>

<body class="layout">
  <!-- Fixed left: 25% width -->
  <aside class="sidebar">
    <h1 class="brand"><a href="https://alinahaseeb.com/">Alina Haseeb</a></h1>
    <nav id="asset-list" class="asset-list"></nav>
    <div class="sidebar-footer">© <span id="year"></span></div>
  </aside>

  <!-- Right: scrollable masonry grid -->
  <main class="gallery">
    <div id="grid" class="masonry"></div>
  </main>

  <script>
    (async () => {
      const res = await fetch('/manifest.json', { cache: 'no-store' });
      const items = await res.json();
      const bySlug = Object.fromEntries(items.map(i => [i.slug, i]));
      const gallery = document.querySelector('.gallery');
      const list = document.getElementById('asset-list');
      const isVideo = url => /\.mp4(\?|$)/i.test(url || '');

      const ua = navigator.userAgent || '';
      const isIOS = /\b(iPad|iPhone|iPod)\b/i.test(ua) || (/\bMacintosh\b/.test(ua) && 'ontouchend' in document);

      const num = (s) => (s?.match(/(?:^|\/)(\d+)_/) || [, ''])[1] || '';
      const THUMB_BASE = (items[0]?.posterSrc || '').replace(/\/[^\/]+$/, '');
      const THUMB_FILES = [
        "10_dragonfountain_thumbnail.png", "11_tundratrees_thumbnail.png", "12_goblinhouse_thumbnail.png",
        "13_dock_thumbnail.png", "14_room_thumbnail.png", "15_volcano_thumbnail.png", "1_potion_thumbnail.png",
        "2_potion_thumbnail.png", "3_furnitureassets_thumbnail.png", "4_oceancutout_thumbnail.png",
        "5_jungletrees_thumbnail.png", "6_orc_thumbnail.png", "7_gardenassets_thumbnail.png",
        "8_waterfall_thumbnail.png", "9_bed_thumbnail.png"
      ];
      const THUMBS = THUMB_FILES.reduce((m, f) => { m[f.split('_')[0]] = `${THUMB_BASE}/${f}`; return m; }, {});

      // sidebar
      const withIndex = items.map(i => {
        const src = i.posterSrc || i.images?.[0] || '';
        const m = src.match(/(?:^|\/)(\d+)_/);
        return { i, n: m ? parseInt(m[1], 10) : Number.MAX_SAFE_INTEGER };
      }).sort((a, b) => a.n - b.n);
      list.innerHTML = withIndex.map(({ i }) =>
        `<a class="asset-link" data-slug="${i.slug}" href="/project.html?slug=${encodeURIComponent(i.slug)}">${i.title || i.slug}</a>`
      ).join('');

      // draw an image from the first video frame if needed
      function paintFirstFrameAsPoster(v) {
        if (v.getAttribute('poster')) return;
        const onLoaded = () => { try { v.currentTime = 0.0; } catch { } };
        const onSeeked = () => {
          try {
            const w = v.videoWidth || 1280, h = v.videoHeight || 720;
            const c = document.createElement('canvas'); c.width = w; c.height = h;
            c.getContext('2d').drawImage(v, 0, 0, w, h);
            v.setAttribute('poster', c.toDataURL('image/jpeg', 0.75));
          } catch { }
          try { v.currentTime = 0; } catch { }
          v.removeEventListener('loadedmetadata', onLoaded);
          v.removeEventListener('seeked', onSeeked);
        };
        v.addEventListener('loadedmetadata', onLoaded, { once: true });
        v.addEventListener('seeked', onSeeked, { once: true });
      }

      function renderGrid() {
        gallery.innerHTML = `<div id="grid" class="masonry"></div>`;
        const g = document.getElementById('grid');

        g.innerHTML = items
          .filter(i => i.section === 'production')
          .map(i => {
            const poster = i.posterSrc || (i.images?.[0] || '');
            const n = num(poster) || num(i.images?.[0] || '') || num(i.slug);
            const thumb = THUMBS[n];

            // iOS: show the PNG thumb; desktop/Android: show the paused video (no autoplay)
            const media = (isIOS && thumb)
              ? `<div class="card-media-wrap">
               <img class="card-media" loading="lazy" alt="${i.title}" src="${thumb}">
             </div>`
              : isVideo(poster)
                ? `<div class="card-media-wrap">
                 <video class="card-media" muted playsinline preload="metadata" poster="">
                   <source src="${poster}" type="video/mp4">
                 </video>
               </div>`
                : `<div class="card-media-wrap">
                 <img class="card-media" loading="lazy" alt="${i.title}" src="${poster}">
               </div>`;

            return `<a class="card" data-slug="${i.slug}" href="/project.html?slug=${encodeURIComponent(i.slug)}" title="${i.title || i.slug}">
                  ${media}
                </a>`;
          }).join('');

        // Desktop/Android hover preview (max 5s)
        g.querySelectorAll('video.card-media').forEach(v => {
          paintFirstFrameAsPoster(v);              // safe no-op on iOS since we don’t render videos there
          v.addEventListener('mouseenter', () => { v.currentTime = 0; v.play(); });
          v.addEventListener('mouseleave', () => { v.pause(); v.currentTime = 0; });
          v.addEventListener('timeupdate', () => { if (v.currentTime >= 5) v.pause(); }, { passive: true });
        });

        // iOS press & hold preview: temporarily overlay a video that autoplays for up to 5s
        if (isIOS) {
          let stopTimer = null;

          const stopPreview = (card) => {
            const overlay = card.querySelector('video.preview-video');
            if (overlay) {
              try { overlay.pause(); } catch { }
              overlay.remove();
            }
            if (stopTimer) { clearTimeout(stopTimer); stopTimer = null; }
          };

          g.addEventListener('touchstart', (e) => {
            const card = e.target.closest('a.card');
            if (!card) return;
            e.preventDefault();                             // don’t navigate; this is a preview
            stopPreview(card);

            const slug = card.getAttribute('data-slug');
            const src = bySlug[slug]?.posterSrc || '';
            if (!/\.mp4(\?|$)/i.test(src)) return;

            const v = document.createElement('video');
            v.className = 'preview-video';
            v.muted = true;
            v.playsInline = true;
            v.preload = 'metadata';
            v.src = src;

            card.appendChild(v);
            try { v.currentTime = 0; } catch { }
            v.play().catch(() => { /* ignore */ });

            // hard-stop at 5s or on touchend/cancel
            stopTimer = setTimeout(() => stopPreview(card), 5000);
          }, { passive: false });

          const end = (e) => {
            const card = e.target.closest('a.card');
            if (!card) return;
            stopPreview(card);
          };
          g.addEventListener('touchend', end, { passive: true });
          g.addEventListener('touchcancel', end, { passive: true });
          g.addEventListener('touchmove', (e) => {
            // if they start scrolling, stop the preview so it doesn’t lag
            const card = e.target.closest('a.card');
            if (card) stopPreview(card);
          }, { passive: true });
        }
      }

      // detail page stays as you have it (autoplay/muted only on the first video if you set that)
      // … your renderDetail(), routing, footer-year, etc …

      // initial render
      renderGrid();
      document.getElementById('year').textContent = new Date().getFullYear();
    })();
  </script>
</body>

</html>