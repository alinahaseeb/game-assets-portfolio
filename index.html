<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Your Name — Game Assets</title>
    <!-- cache-bust the stylesheet -->
    <link rel="stylesheet" href="/style.css?v=2"/>
  </head>
  <body class="layout">
    <!-- Fixed left: 25% width -->
    <aside class="sidebar">
      <div class="brand">Your Name</div>
      <nav id="asset-list" class="asset-list"></nav>
      <div class="sidebar-footer">© <span id="year"></span></div>
    </aside>

    <!-- Right: scrollable masonry grid -->
    <main class="gallery">
      <div id="grid" class="masonry"></div>
    </main>

    <script>
      (async () => {
        const res = await fetch('/manifest.json', { cache: 'no-store' });
        const items = await res.json();

        // Sidebar list (sorted by numeric prefix if present)
        const withIndex = items.map(i => {
          const src = i.posterSrc || i.images?.[0] || '';
          const m = src.match(/(?:^|\/)(\d+)_/);
          return { i, n: m ? parseInt(m[1], 10) : Number.MAX_SAFE_INTEGER };
        }).sort((a,b) => a.n - b.n);

        const list = document.getElementById('asset-list');
        list.innerHTML = withIndex.map(({i}) =>
          `<a class="asset-link" href="/project.html?slug=${encodeURIComponent(i.slug)}">${i.title || i.slug}</a>`
        ).join('');

        // Grid cards
        const isVideo = url => /\.mp4(\?|$)/i.test(url || '');
        const grid = document.getElementById('grid');

        grid.innerHTML = items
          .filter(i => i.section === 'production')
          .map(i => {
            const poster = i.posterSrc || (i.images?.[0] || '');
            const media = isVideo(poster)
              ? `<div class="card-media-wrap">
                  <video class="card-media" muted preload="metadata" playsinline
                          onmouseenter="this.currentTime=0; this.play()"
                          onmouseleave="this.pause(); this.currentTime=0;">
                    <source src="${poster}" type="video/mp4">
                  </video>
                </div>`
              : `<div class="card-media-wrap">
                  <img class="card-media" loading="lazy" alt="${i.title}" src="${poster}">
                </div>`;

            return `
              <a class="card" href="/project.html?slug=${encodeURIComponent(i.slug)}" title="${i.title || i.slug}">
                ${media}
              </a>`;
          }).join('');

        // === Add preview controls ===
        grid.querySelectorAll('video.card-media').forEach(v => {
          // Stop after 5s
          v.addEventListener('timeupdate', () => {
            if (v.currentTime >= 5) v.pause();
          }, { passive:true });

          // Mobile: tap + hold (touchstart)
          v.addEventListener('touchstart', () => {
            v.currentTime = 0;
            v.play();
          }, { passive:true });

          // Release finger or cancel scroll → pause + reset
          const stop = () => { v.pause(); v.currentTime = 0; };
          v.addEventListener('touchend', stop, { passive:true });
          v.addEventListener('touchcancel', stop, { passive:true });
        });

        document.getElementById('year').textContent = new Date().getFullYear();
      })();
    </script>
  </body>
</html>
